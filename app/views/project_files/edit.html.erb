<!-- app/views/project_files/edit.html.erb -->
<div class="editor-container" style="height: 100vh; display: flex; flex-direction: column; background-color: #f8f9fa;">
  <!-- Header Bar -->
  <div class="d-flex justify-content-between align-items-center px-3 py-2 bg-white shadow-sm border-bottom sticky-top" style="z-index: 100;">
    <h5 class="mb-0">
      ğŸ“ Editing: <strong><%= @file_name %></strong>
      <span class="text-muted">(<%= @language.capitalize %>)</span>
      <span class="badge bg-secondary">Branch: <%= @branch_name %></span>
    </h5>

    <div class="d-flex gap-2">
      <button id="saveBtn" class="btn btn-outline-success" title="Save without commit">ğŸ’¾ Save</button>
      <button id="commitBtn" class="btn btn-outline-primary" title="Save and commit changes">âœ… Commit</button>
      <button id="exitBtn" class="btn btn-outline-danger" title="Exit without saving">ğŸšª Exit</button>
    </div>
  </div>

  <!-- Monaco Editor -->
  <div id="editor" style="flex-grow: 1; border-top: 1px solid #ddd;"></div>
</div>

<%= javascript_importmap_tags %>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

<script type="module">
  import { createConsumer } from "@rails/actioncable";

  const projectId = <%= @project.id %>;
  const fileName = "<%= @file_name %>";
  const initialContent = `<%= raw @file_content %>`;
  const language = "<%= @language %>";
  const branchName = "<%= @branch_name %>";
  const currentPath = "<%= @file_path %>";

  const saveUrl = `/projects/${projectId}/files/${encodeURIComponent(fileName)}/save?path=${encodeURIComponent(currentPath)}`;
  const commitUrl = `/projects/${projectId}/files/${encodeURIComponent(fileName)}/commit?path=${encodeURIComponent(currentPath)}`;
  const redirectUrl = `/projects/${projectId}/files?path=${encodeURIComponent(currentPath)}`;

  let editor;
  let lastContent = initialContent;
  let isApplyingRemoteUpdate = false;

  require.config({ paths: { vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs" } });

  require(["vs/editor/editor.main"], function () {
    editor = monaco.editor.create(document.getElementById("editor"), {
      value: initialContent,
      language: language,
      automaticLayout: true,
      theme: "vs",
      fontSize: 14,
      minimap: { enabled: false },
      wordWrap: "on",
      padding: { top: 10, bottom: 10 },
    });

    const consumer = createConsumer();

    const channel = consumer.subscriptions.create(
      {
        channel: "EditorChannel",
        project_id: projectId,
        file_id: fileName,
        branch: branchName
      },
      {
        received(data) {
          if (data.content !== lastContent) {
            isApplyingRemoteUpdate = true;
            lastContent = data.content;

            const position = editor.getPosition();
            editor.setValue(data.content);
            editor.setPosition(position);

            setTimeout(() => {
              isApplyingRemoteUpdate = false;
            }, 100);
          }
        }
      }
    );

    let debounceTimer;
    editor.onDidChangeModelContent(() => {
      if (isApplyingRemoteUpdate) return;

      const content = editor.getValue();
      lastContent = content;

      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        channel.send({ content: content });
      }, 300);
    });

    document.getElementById("saveBtn").addEventListener("click", () => {
      saveContent(() => {
        window.location.href = redirectUrl;
      });
    });

    document.getElementById("commitBtn").addEventListener("click", () => {
      const message = prompt("Enter commit message:");
      if (!message) return;

      saveContent(() => {
        fetch(commitUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({ message: message })
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === "success") {
              alert("âœ… Committed successfully.");
              window.location.href = redirectUrl;
            } else {
              alert("âŒ Commit failed: " + data.message);
            }
          });
      });
    });

    document.getElementById("exitBtn").addEventListener("click", () => {
      if (confirm("Are you sure you want to exit without saving?")) {
        window.location.href = redirectUrl;
      }
    });

    function saveContent(callback) {
      fetch(saveUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ content: editor.getValue(), path: currentPath })
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === "success") {
            callback();
          } else {
            alert("âŒ Save failed: " + data.message);
          }
        });
    }
  });
</script>
